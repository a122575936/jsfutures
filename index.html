<!DOCTYPE html>
<html>
<head>
  <title>My OS Platform</title>
</head>
<style>

    body {
        font: 10px sans-serif;
    }

    .axis path,
    .axis line {
        fill: none;
        stroke: #000;
        shape-rendering: crispEdges;
    }

    path.candle {
        stroke: #000000;
    }

    path.candle.body {
        stroke-width: 0;
    }

    path.candle.up {
        fill: #FF0000;
        stroke: #FF0000;
    }

    path.candle.down {
        fill: #00AA00;
        stroke: #00AA00;
    }

</style>
<body>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="http://techanjs.org/techan.min.js"></script>
<script charset="gb2312" type="text/javascript" src="http://data.eastmoney.com/futures/js/FData.js"></script>
<!--<script type="text/javascript" src="jquery-1.12.0.js"></script>-->
<script>
var request = require('request');
var sprintf = require("sprintf-js").sprintf
var _ = require("underscore")
var contractDatas = {}

function getMainContracts()
{
    return cc.slice(0, cc.length - 1).map(function(c){return c.newContract})
}

function getHexunUrl(contract)
{
    var c = getCode(contract)
    var e = getExchange(contract)
    //console.log('contract ', contract)
    //console.log('exchange ', e)
    var config = {}
    config[1] = "SHFE3"
    config[3] = "DCE"
    config[4] = "CZCE"
    config[5] = "CFFEX"
    if (e == 1)
    {
        var code = {}
        code['AG'] = "SHFE2"
        code['AL'] = "SHFE3"
        code['AU'] = "SHFE2"
        code['BU'] = "SHFE3"
        code['CU'] = "SHFE3"
        code['HC'] = "SHFE3"
        code['NI'] = "SHFE3"
        code['RB'] = "SHFE3"
        code['RU'] = "SHFE"
        code['ZN'] = "SHFE3"
        config[1] = code[c]
    }
    var url = sprintf("http://webftcn.hermes.hexun.com/shf/kline?code=%s%s&start=20160304210000&number=-960&type=2", config[e], contract.toLowerCase())
    return url
}

function loadDataHexun(contract)
{
    var url = getHexunUrl(contract)
    //console.log('hexun url ', url)
    request(url, function (error, response, body) {
      if (!error && response.statusCode == 200) {
        //console.log(body) // Show the HTML for the Google homepage.
        var hlocs = eval(body)
        //console.log('contract ', contract)
        //console.log(hlocs)
        //console.log('length of data ', hlocs.Data[0].length)
        contractDatas[contract] = hlocs.Data[0]
      }
      else
      {
        console.log('load data error ', contract)
      }
    })
}

function loadData(contract, oncomplete)
{
    request('http://stock2.finance.sina.com.cn/futures/api/json.php/IndexService.getInnerFuturesMinLine?symbol=' + contract, function (error, response, body) {
      if (!error && response.statusCode == 200) {
        //console.log(body) // Show the HTML for the Google homepage.
        var hlocs = JSON.parse(body)
        //console.log(hlocs)

        function in_trading_time(hloc)
        {
            if (hloc.length < 4)
            {
                return false
            }
            var t = hloc[4]
            var ts = t.split(':')
            var h = parseInt(ts[0])
            var m = parseInt(ts[1])

            if(h == 10 && (15 <= m && m <= 29))
            {
                return false
            }
            if(h == 11 && m == 30)
            {
                return false
            }
            if(h == 15 && m == 0)
            {
                return false
            }
            if(15 <= h && h <= 20)
            {
                return false
            }
            var localtime = new Date()
            if (h < 20 && localtime.getHours() >= 20)
            {
                return false
            }
            return true
        }
        
        if (hlocs == null)
        {
            //console.log('hlocs is null ', contract)
            return null
        }
        //console.log('len of hlocs ', hlocs.length)
        hlocs = hlocs.filter(in_trading_time)
        //console.log('len of hlocs ', hlocs.length)

        function to_hloc(arr)
        {
            var hloc = {}
            hloc.h = parseFloat(arr[0])
            hloc.l = parseFloat(arr[0])
            hloc.o = parseFloat(arr[0])
            hloc.c = parseFloat(arr[0])
            hloc.v = parseInt(arr[2])
            hloc.t = arr[4]
            return hloc
        }
        hlocs = hlocs.map(to_hloc)
        //console.log(hlocs)
        oncomplete && oncomplete(hlocs, contract)
      }
    })
}

function last(arr)
{
    return arr[arr.length - 1]
}

function convert(hlocs)
{
    if (hlocs.length <= 0)
    {
        return null
    }
    function get_close(hloc)
    {
        return hloc.c
    }
    function get_volume(hloc)
    {
        return hloc.v
    }
    var prices = hlocs.map(get_close)
    var volume = hlocs.map(get_volume)
    var hloc = {}
    var max = Math.max.apply(null, prices)
    var min = Math.min.apply(null, prices)
    hloc.h = max
    hloc.l = min
    hloc.o = prices[0]
    hloc.c = last(prices)
    hloc.v = volume.reduce(function(a, b){ return a + b }, 0)
    //console.log(hlocs[0])
    hloc.t = hlocs[0].t
    //console.log(prices)
    //console.log(hloc.o)
    //console.log(hloc.c)
    return hloc
}

function convert1minto15min(hlocs)
{
    var index = hlocs.length / 15
    if (hlocs.length % 15 > 0)
    {
        index += 1
    }

    var ret = []
    for (var i = 0; i < index; i++)
    {
        var hloc = convert(hlocs.slice(i * 15, (i + 1) * 15))
        if (hloc == null)
        {
            //console.log('hloc is null')
        }
        else
        {
            ret.push(hloc)
        }
    }
    return ret
}

function getCode(contract)
{
    if (!contract)
    {
        return ""
    }
    var code = contract.match(/\D*/)[0]
    return code
}

function getExchange(contract)
{
    if (!contract)
    {
        return -1
    }
    var code = contract.match(/\D*/)[0]
    for (var i = 0; i < cv.length; i++)
    {
        var arr = cv[i].data
        for (var j = 0; j < arr.length; j++)
        {
            var obj = arr[j]
            if (obj[0].toLowerCase() == code.toLowerCase())
            {
                var config = []
                config[0] = 3
                config[1] = 1
                config[2] = 4
                config[3] = 5
                return config[i]
            }
        }
    }
    return -1
}

function getNeteaseContract(contract)
{
    var code = getCode(contract)
    if (_.include(["CF", "TA", "MA", "WH", "FG", "OI", "RM", "ZC", "SR"], code.toUpperCase()))
    {
        var time = contract.substr(contract.length - 3, 3)
        return code + time
    }
    else
    {
        return contract.toLowerCase()
    }
}

function parseData(hlocs, contract)
{
    hlocs = convert1minto15min(hlocs)
    if (hlocs.length < 2)
    {
        //console.log('less then 2 ', contract)
        return
    }

    var last = hlocs[hlocs.length - 1]
    var lastbutone = hlocs[hlocs.length - 2]

    var volumelast = last.v
    var volumelastbutone = parseFloat(lastbutone.v)

    if (volumelast <= 0 || volumelastbutone <= 0)
    {
        //console.log('volume less then 0 ', contract)
        return
    }

    //console.log(contract)

    closelast = last.c
    closelastbutone = lastbutone.c

    volumerate = volumelast / volumelastbutone
    closerate = (closelast - closelastbutone) / closelastbutone

    
    //console.log("%.2f, %s %d %d", closerate, contract, closelast, closelastbutone)
    var str = sprintf("%.3f, %s", closerate, contract)
    var img_url = sprintf("http://img1.money.126.net/chart/fu/kline/day/180/%s.png?v=%f", getNeteaseContract(contract), Math.random())
    if (Math.abs(closerate) > 0.003)
    {
        var div_futures = document.getElementById("div_futures")
        var div = document.createElement('div')
        var p = document.createElement('p')
        p.innerHTML = str
        //div.appendChild(p)
        var img = document.createElement('img')
        img.src = img_url
        //div.appendChild(img)
        //div_futures.appendChild(img)
        var data = contractDatas[contract]
        if (data)
        {
            showChart(data, str)
        }
    }
    if (Math.abs(closerate) > 0.004)
    {
        console.error(str)
    }
    else if (Math.abs(closerate) > 0.003)
    {
        console.info(str)
    }
}

function showChart(hlocs, str)
{
    var margin = {top: 20, right: 20, bottom: 30, left: 50},
            width = 960 - margin.left - margin.right,
            height = 500 - margin.top - margin.bottom;

    var parseDate = d3.time.format("%Y%m%d%H%M%S").parse;

    var x = techan.scale.financetime()
            .range([0, width]);

    var y = d3.scale.linear()
            .range([height, 0]);

    var candlestick = techan.plot.candlestick()
            .xScale(x)
            .yScale(y);

    var xAxis = d3.svg.axis()
            .scale(x)
            .orient("bottom");

    var yAxis = d3.svg.axis()
            .scale(y)
            .orient("left");

    var svg = d3.select("div").append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    var accessor = candlestick.accessor();

    data = hlocs.slice(0, 300).map(function(d) {
        return {
            date: parseDate(d[0].toString()),
            open: +d[2],
            high: +d[4],
            low: +d[5],
            close: +d[3],
            volume: +d[6]
        };
    }).sort(function(a, b) { return d3.ascending(accessor.d(a), accessor.d(b)); });

    x.domain(data.map(accessor.d));
    y.domain(techan.scale.plot.ohlc(data, accessor).domain());

    svg.append("g")
            .datum(data)
            .attr("class", "candlestick")
            .call(candlestick);

    svg.append("g")
            .attr("class", "x axis")
            .attr("transform", "translate(0," + height + ")")
            .call(xAxis)
            .append("text")
            .attr("x", width - 70)
            .attr("y", -6)
            .text(str);

    svg.append("g")
            .attr("class", "y axis")
            .call(yAxis)
            .append("text")
            .attr("transform", "rotate(-90)")
            .attr("y", 6)
            .attr("dy", ".71em")
            .style("text-anchor", "end")
            .text("Price ($)");
}
// get the system platform using node.js
//var os = require('os');
//document.write('You are running on ', os.platform());
var contracts = getMainContracts()
//console.log(contracts)
function onInterval()
{
    var div_futures = document.getElementById("div_futures")
    while (div_futures && div_futures.hasChildNodes())
    {
        div_futures.removeChild(div_futures.lastChild)
    }
    console.log('-------------------------------------')
    console.log('-------------------------------------')
    contracts.map(function(contract){
        //console.log('convertContract ', convertContract(contract))
        loadData(contract, parseData)
        loadDataHexun(contract)
    })
}
setInterval("onInterval()", 60000)
onInterval()
</script>
<br />
<div id="div_futures"/>
</body>
</html>
